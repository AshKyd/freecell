var FreecellGame=Backbone.Model.extend({defaults:{current:false,suits:1,debug:false,timeStart:0,timePaused:0,undoPenalty:0,seed:0},scoreDefs:{storageEngine:"chromesync",classes:["regular"],fields:{time:{type:"average"},movesAverage:{type:"average"},movesLowest:{type:"custom"},won:{type:"addition",streak:true},lost:{type:"addition",streak:true},}},move:false,undoHistory:[],positions:{deck:16,homecells:12,freecells:8,tableau:0},startMove:function(){this.move=[]},endMove:function(){if(this.move&&this.move.length>0){this.undoHistory.push(this.move);this.move=false}this.trigger("change:piles")},undoMove:function(){var a=this.undoHistory.pop();if(typeof a=="undefined"){this.trigger("change:undo",false);return}this.set("undoPenalty",this.get("undoPenalty")+1);this.trigger("change:undo",true);for(var b=0;b<a.length;b++){if(a[b].action=="visibility"){a[b].card.set("visibility",a[b].visibility)}if(a[b].action=="pos"){this.moveCards(a[b].card.pos.row,a[b].card.pos.height,a[b].oldPos.row,true)}}this.move=false;this.endMove()},getMoveCount:function(){return this.undoHistory.length+this.get("undoPenalty")*2},getTime:function(b){if(typeof b=="undefined"){b="mins"}var a=Math.round(((new Date()).getTime()-this.get("timeStart"))/1000);if(b=="secs"){return a}else{if(b=="mins"){return this.getFormattedTime(a)}}},getFormattedTime:function(a){var b=Math.round(a/60);a=Math.round(a%60);if(a<10){a="0"+a}return b+":"+a},getScore:function(){var b=0;for(var a=this.positions.freecells;a<this.positions.homecells;a++){if(this.piles[a].length>0){b++}}return 500-this.getMoveCount()+b*100},initialize:function(){this.piles=[];for(var a=0;a<20;a++){this.piles[a]=[]}this.cards=new Deck({deckCount:1,seed:this.get("seed")});this.attachEvents();this.cards.shuffle();for(var a=0;a<52;a++){var c=this.cards.next();this.setCardVisibility(c,true);this.addCard(c,a%8)}var b=this;this.bind("change:piles",function(){b.checkGameStatus()});this.move=false;this.set("timeStart",(new Date()).getTime());this.undoHistory=[]},getHint:function(){var a=false;var m=false;var n=false;var b=false;var g=false;var l=0;var c=[];for(var h=this.positions.freecells;h<this.positions.homecells;h++){if(this.piles[h].length==0){continue}for(var f=this.positions.tableau;f<this.positions.freecells;f++){a=this.piles[h][0];n=this.getTopCard(f);if(this.canMoveCardTo(a,n)){return{src:a,dest:n}}}}for(var h=this.positions.tableau;h<this.positions.freecells;h++){if(this.piles[h].length==0){continue}n=this.getTopCard(h);m=this.canMoveToHomeCell(n);if(m){return{src:n,dest:m}}g=this.getHighestMovableCard(h);for(var f=g.pos.height-1;f<=n.pos.height-1;f++){a=this.piles[h][f];for(var e=0;e<this.positions.freecells;e++){m=this.getTopCard(e);if(!this.canMoveCardTo(a,m)){continue}l=0;if(f>0){b=this.piles[h][f-1];if(!this.canMoveCard(b)){l+=10}if(b.get("number")==1){l+=11}else{if(this.canMoveToHomeCell(b)){l+=10}}if(this.getClosestCardOfNum(h,1)){l+=3}if(this.getClosestCardOfNum(m.pos.row)){l-=10}var o=this.getHighestMovableCard(h,true);var d=this.getHighestMovableCard(e,true);o=this.piles[h].length-o.pos.height;d=this.piles[e].length-d.pos.height;if(o>=d&&b.get("number")==m.get("number")){continue}}else{l+=18}c.push({src:a,dest:m,weighting:l})}}}if(c.length==0){return false}c.sort(function(j,i){if(j.weighting<i.weighting){return 1}else{return -1}});return c[0]},canMoveToHomeCell:function(c){if(c.get("number")==1){return{name:"homecell",pos:{row:this.getEmptyHomeCell()}}}for(var b=0;b<4;b++){var a=this.getTopCard(this.positions.homecells+b);if(a&&this.canMoveCardTo(c,a)){return a}}return false},attachEvents:function(){var b=this;for(var a=0;a<this.cards.cards.length;a++){this.cards.cards[a].bind("change:css",function(c){b.trigger("change:css",c)})}},addCard:function(a,b){this.piles[b].push(a);this.updatePos(a,b)},setCardVisibility:function(b,a,c){if(typeof b=="undefined"){return}if(!c){if(!this.move){this.startMove()}this.move.push({action:"visibility",card:b,visibility:b.get("visibility")})}b.set("visibility",a)},updatePos:function(b,d,a,c){if(d>=this.positions.freecells){}if(!c&&typeof b.pos!="undefined"){if(!this.move){this.startMove()}this.move.push({action:"pos",card:b,oldPos:_.extend({},b.pos),visibility:b.get("visibility")})}b.pos={row:d,height:_.isUndefined(a)?this.piles[d].length:a};if(d<this.positions.freecells){b.pos.name="tableau";b.pos.col=d}else{if(d<this.positions.homecells){b.pos.name="freecells";b.pos.col=d-this.positions.freecells}else{if(d<this.positions.deck){b.pos.name="homecells";b.pos.col=d-this.positions.freecells}else{console.log("uhhh...",d)}}}return b},moveCard:function(d,b){if(!d||!b){return}var f=this.piles[d.pos.row];var a=this.piles[b.pos.row];var e=this.checkColumn(d.pos.row,d.pos.height-1);var c=this.getTopCard(b.pos.row);if(this.get("debug")){console.log("debug mode, allowing move");this.moveCards(d.pos.row,d.pos.height,b.pos.row,false);this.automaticMoves();return true}if(!e.alternatingColor){return false}if(this.canMoveCard(d)&&this.canMoveCardTo(d,b)){this.moveCards(d.pos.row,d.pos.height,b.pos.row,false);this.automaticMoves();return true}else{return false}},automaticMoves:function(){var d=true;var o=false;for(var g=this.positions.tableau;g<this.positions.freecells;g++){var h=this.checkColumn(g,g);if(h&&(!h.alternatingColor||!h.ordered)){d=false}o=this.getTopCard(g);if(o&&o.get("number")==1){var m={pos:{row:this.getEmptyHomeCell()}};this.moveCard(o,m)}else{if(o&&o.get("number")==2){for(var f=this.positions.homecells;f<this.positions.deck;f++){var e=this.getTopCard(f);if(this.piles[f].length==1&&e.get("suitName")==o.get("suitName")){this.moveCard(o,e)}}}}}if(!d){return}var b=0;var l=this;var k=function(){b=0;for(var j=l.positions.tableau;j<l.positions.freecells;j++){b+=l.piles[j].length}return b};var p={};for(var g=this.positions.homecells;g<this.positions.deck;g++){if(this.piles[g].length==0){return}p[this.piles[g][0].get("suitName")]=g}var a,n;var c=1000;while(k()>0){for(var g=this.positions.tableau;g<this.positions.freecells;g++){a=this.getTopCard(g);if(a){n=this.getTopCard(p[a.get("suitName")]);this.moveCard(a,n)}}if(c--<=0){break}}},getCardFromBottom:function(a,b){if(typeof this.piles[a][this.piles[a].length-b]!=undefined){return this.piles[a][this.piles[a].length-b]}return false},getClosestCardOfNum:function(c,a){for(var b=this.piles[c].length-1;b>=0;b--){if(this.piles[c][b].get("number")==a){return this.piles[c][b]}}return false},moveCards:function(f,b,c,e){var a=this.piles[f].splice(b-1);for(var d=0;d<a.length;d++){this.piles[c].push(a[d]);this.updatePos(a[d],c,this.piles[c].length,e)}if(b>=2){this.setCardVisibility(this.piles[f][b-2],true,e)}this.endMove()},checkGameStatus:function(){if(this.hasWinState()){this.gameWon();return}},gameWon:function(){this.writeGameStats("won",function(){this.trigger("game:won")})},loadGameStats:function(a){if(!this.score){this.score=new Scoreboard(this.scoreDefs);this.score.load(a)}else{a()}},writeGameStats:function(c,d){var b=this;var a=this.getMoveCount();if(a<10){d.call(b);return}this.loadGameStats(function(){var e=b.score.getField("regular","movesLowest");if(e==0||e>a){e=a}if(c=="won"){b.score.updateFields("regular",{time:b.getTime("secs"),movesAverage:a,movesLowest:e,won:1});b.score.resetStreak("regular","lost")}else{b.score.updateField("regular","lost",1);b.score.resetStreak("regular","won")}b.score.save(function(){d.call(b)})})},getGameStats:function(b){var a=this;this.loadGameStats(function(){b(a.score.getFields())})},getBadges:function(b){var a=this;this.getGameStats(function(d){var c=[];if(d.regular.won.streakLength){switch(d.regular.won.streakLength){case 5:case 10:case 25:case 50:c.push({badge:"winningstreak-small",val:d.regular.won.streakLength})}if(d.regular.won.streakLength%1000==0){c.push({badge:"winningstreak-huge",val:d.regular.won.streakLength})}else{if(d.regular.won.streakLength%100==0){c.push({badge:"winningstreak-large",val:d.regular.won.streakLength})}}}if(a.getMoveCount()<=d.regular.movesLowest.val){c.push({badge:"best-moves",val:a.getMoveCount()})}if(a.getTime("secs")<=d.regular.time.val){c.push({badge:"improved-time",val:a.getTime("secs")})}b(c)})},hasWinState:function(){var a=52;for(var b=this.positions.homecells;b<this.positions.deck;b++){a-=this.piles[b].length}if(a==0){return true}return false},deckSize:function(){return this.piles[this.positions.deck].length},getCards:function(){return _.isUndefined(this.cards.cards)?[]:this.cards.cards},getTopCard:function(a){return this.getCardFromBottom(a,1)},getHighestMovableCard:function(d,c){if(this.piles[d].length==0){return false}var b=this.getTopCard(d);if(this.piles[d].length==1){return b}for(var a=this.piles[d].length-1;a>=0;a--){if(!this.canMoveCard(this.piles[d][a],c)){return b}b=this.piles[d][a]}return b},checkColumn:function(f,g){if(_.isUndefined(this.piles[f][g])){return false}var e={mixedSuit:false,alternatingColor:true,ordered:true,suitName:this.piles[f][g].get("suitName"),firstNum:this.piles[f][g].get("number"),cards:this.piles[f].length-g};var d=false;var b=false;for(var c=g;c<this.piles[f].length;c++){var a=this.piles[f][c];if(c==g){e.suitName=a.get("suitName");e.firstNum=a.get("number")}else{if(d!=a.get("number")+1){e.ordered=false}}if(e.suitName!=a.get("suitName")){e.mixedSuit=true;e.suitName="mixed"}if(b!=false){if(b==a.getColor()){e.alternatingColor=false}}d=a.get("number");b=a.getColor()}return e},canMoveCard:function(b,d){if(typeof d=="undefined"){d=false}if(this.get("debug")){return true}if(typeof b=="undefined"){return false}if(!d&&b.pos.row>=this.positions.homecells){return false}var c=this.checkColumn(b.pos.row,b.pos.height-1);var a=this.piles[b.pos.row].length-b.pos.height;if(c.alternatingColor&&c.ordered&&a<=this.getFreeCells()+1){return true}return false},canMoveCardTo:function(b,a){if(typeof b=="undefined"||typeof a=="undefined"){return false}if(a.pos.row<this.positions.freecells){if((a.getColor()!=b.getColor()&&b.get("number")==a.get("number")-1)||(this.piles[a.pos.row].length==0)){return true}}else{if(a.pos.row<this.positions.homecells){if(this.piles[a.pos.row].length==0&&b.pos.height==this.piles[b.pos.row].length){return true}}else{if(a.pos.row<this.positions.deck){if((this.piles[a.pos.row].length==0&&b.get("number")==1)||(a.get("suitName")==b.get("suitName")&&b.get("number")==a.get("number")+1)){return true}}}}return false},getFreeCells:function(){var b=0;for(var a=this.positions.freecells;a<this.positions.deck;a++){if(this.piles[a].length==0){b++}}return b},getEmptyFreeCell:function(){return this.getEmptyCell(this.positions.freecells,this.positions.homecells)},getEmptyHomeCell:function(){return this.getEmptyCell(this.positions.homecells,this.positions.deck)},getEmptyCell:function(c,b){for(var a=c;a<b;a++){if(this.piles[a].length==0){return a}}return false},moveToFreeCell:function(a){if(a.pos.height!=this.piles[a.pos.row].length){return}var b=this.canMoveToHomeCell(a);if(!b){b=this.getEmptyFreeCell();if(!b){return false}b={name:"freecells",pos:{row:b}}}this.moveCard(a,b)}});