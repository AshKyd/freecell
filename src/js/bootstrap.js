var Dialog=Backbone.View.extend({events:{"click .item":"returnItem","click .close":"returnClose"},templateString:'<div style="opacity:0" class="dialog <%- className %>"><%= html %><ul><% _.each(items, function(item) { %> <li class="item" id="<%= item.id %>"><h2><%= item.name %></h2><span class="addendum">&nbsp;<%= item.addendum %></span><p><%= item.description %></p></li> <% }); %></ul></div>',initialize:function(b){if(_.isUndefined(b.el)){this.el=$("<div></div>");$("body").append(this.el);this.delegateEvents()}this.callback=b.callback;this.items=b.items;this.className=b.className;this.title=b.title;this.html=b.html;this.render()},returnItem:function(b){for(var c=0;c<this.items.length;c++){if(this.items[c].id==$(b).attr("id")){this.callback(this.items[c]);break}}this.remove();return true},returnClose:function(){this.callback(false);this.remove();return false},remove:function(){$(this.el).children().css("opacity",0);window.setTimeout(function(){$(this.el).remove()},500)},render:function(){var a=_.template(this.templateString,this);a=$(a);$(this.el).append(a);window.setTimeout(function(){a.css("opacity",1)},100);this.delegateEvents();var b=this;$(".close",this.el).click(function(){b.returnClose(this)});$(".item",this.el).click(function(){b.returnItem(this)});return this}});(function(e){var n=function(o){return o};var l=500;var m=false;var g=false;var k=false;function c(o){if(g){g=false}e("#gameboard,.dialog,.gamenumber").css("opacity",0);window.setTimeout(function(){e("#gameboard,.dialog").remove();e(".gamenumber").text("");o()},l*2);g=false;k=false;e("#toolbar").removeClass("gameactive")}function h(){if(!g){g=new FreecellGame()}g.getGameStats(function(q){console.log(q);var s=function(u,v,t){r+='<div class="'+u+'"><div class="title">'+v+'</div><div class="value">'+t+"</div></div>"};var r='<div class="column left"><h2 class="large" data-i18n="interface.scoreboard.scoreboard">Scoreboard</h2>';var o=q.regular.won.val+q.regular.lost.val;var p=Math.round((q.regular.won.val/o)*100);if(isNaN(p)){p=0}if(q.regular.won.streakLength){s("badgeblock winstreak",n("interface.scoreboard.winning-streak"),q.regular.won.streakLength)}if(q.regular.lost.streakLength){s("badgeblock losingstreak",n("interface.scoreboard.losing-streak"),q.regular.lost.streakLength)}s("badgeblock gamesplayed",n("interface.scoreboard.games-played"),o);s("badgeblock averagetime",n("interface.scoreboard.average-time"),g.getFormattedTime(q.regular.time.val));r+='<table><tbody><tr><th></th><th data-i18n="interface.scoreboard.total">Total</th><th data-i18n="interface.scoreboard.longest-streak">Longest Streak</th></tr><tr><th data-i18n="interface.scoreboard.won">Won</th><td>'+q.regular.won.val+"</td><td>"+q.regular.won.streakMax+'</td></tr><tr><th data-i18n="interface.scoreboard.lost">Lost</th><td>'+q.regular.lost.val+"</td><td>"+q.regular.lost.streakMax+"</td></tr></tbody></table>";r+='</div><div class="column right">';s("winpercent",n("interface.scoreboard.percentage-won"),p);r+="</div>";c(function(){var t=new Dialog({title:n("interface.scoreboard.scoreboard"),className:"scoreboard",items:[],html:r,callback:function(u){}});e(".dialog.scoreboard").i18n()})})}function b(p){var r=g.getTime("secs");var q=g.get("seed");var o=g.getMoveCount();g.getBadges(function(u){g=false;var t="";for(var v=0;v<u.length;v++){t+='<div class="badgeholder"><div class="badge '+u[v].badge+'"></div><p>'+n("interface.badges."+u[v].badge,{val:u[v].val})+"</p></div>"}var s=[{name:n("interface.gameover.items.new-game.name"),id:"play-another",addendum:"",description:n("interface.gameover.items.new-game.description")}];var w=p=="nomoves"?n("interface.gameover.no-moves"):n("interface.gameover.won");var x=i18n.t("interface.toolbar.moves",{moves:o})+" â€” "+i18n.t("interface.toolbar.gamenumber",{gamenumber:q});c(function(){var y=new Dialog({title:w,className:"gameComplete",items:s,html:'<h2 class="large center">'+w+'</h2><p class="minor selectable">'+x+"</p>"+t,callback:function(z){if(z==false){}else{if(z.id=="play-another"){f()}}}});e(".badgeholder").click(function(){h()})})})}function a(o){c(function(){var q=new Dialog({title:n("interface.loadgame.load-game"),className:"loadGame",items:[],html:'<h2 class="large center">'+n("interface.loadgame.load-game")+'</h2><p class="minor">'+n("interface.loadgame.load-game-description")+'</p><form method="GET" action="#"><table><tr><td colspan="2"><label for="gameid">'+n("interface.loadgame.game-id")+'</label></td></tr><tr><td><input type="text" value="'+d()+'" id="gameid" name="gameid"></td><td><button>'+n("interface.loadgame.verb")+"</button></td></td></table></form>",callback:function(r){if(r==false){}else{if(r.id=="play-another"){f()}}}});var p=function(){var r=e("#gameid").val();if(r&&!isNaN(r)&&isFinite(r)){f(r)}else{alert(n("interface.loadgame.load-game-error"))}return false};e("form").submit(function(){return p()});e("button").click(function(){return p()})})}function d(){return Math.round(Math.random()*1000000)}function f(o){if(typeof o=="undefined"){o=d()}c(function(){var p=e('<div id="gameboard"></div>').css("opacity","0");e("body").append(p);g=new FreecellGame({seed:o});e(".gamenumber").text(o);k=new FreecellGameView({model:g,el:p[0],complete:function(q){window.setTimeout(function(){b(q)},l*4)}});window.view=k;window.model=g;e("#toolbar").addClass("gameactive");e("#gameboard").css("opacity","1");e(".gamenumber").css("opacity",".5")})}function j(){c(function(){var o=new Dialog({title:"About",className:"gameAbout",items:false,html:n("about"),callback:function(){}})})}function i(){c(function(){var o=new Dialog({title:"About",className:"gameRules",items:false,html:n("rules"),callback:function(){}})})}window.addEventListener("beforeunload",function(o){if(g){g.writeGameStats("lost",function(){})}});e(document).ready(function(){i18n.init({useCookie:false,resGetPath:"locales/__lng__/__ns__.json",fallbackLng:"en",customLoad:function(s,r,q,p){if(typeof languages[s.toLowerCase()]!="undefined"){var o=languages[s.toLowerCase()];p(null,o)}else{p("nuts",{})}}},function(p){n=p;e("#toolbar").i18n();e("body").css("height",window.innerHeight+"px");var o=function(){e("#tb-menu").removeClass("toggled");e("body").unbind("click")};e("#tb-menu a").click(function(){var q=e(this).parent().toggleClass("toggled");if(q.hasClass("toggled")){e("body").bind("mousedown",function(r){if(e(r.target).closest("#tb-menu").length==0){o()}})}else{o()}});e("#tb-newgame").click(function(){c(function(){f()});o();return false});e("#tb-restartgame").click(function(){var q=g?g.get("seed"):undefined;c(function(){f(q)});o();return false});e("#tb-about").click(function(){j();o();return false});e("#tb-rules").click(function(){i();o();return false});e("#tb-loadgame").click(function(){c(a);o();return false});e("#tb-undo").click(function(){g.undoMove();return false});e("#tb-hint").click(function(){k.getHint();return false});e(window).load(function(){f()})})})})($);